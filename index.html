<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Little Ollie Slider Puzzle</title>

  <style>
    * { box-sizing: border-box; }
    :root{
      --gap: 4px;          /* smaller gaps */
      --radius: 8px;       /* less rounded */
      --tileShadow: 0 10px 20px rgba(0,0,0,.25);
      --panel: rgba(0,0,0,.20);
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:18px 10px 30px;
      background: radial-gradient(circle at top, #6de0ff, #4c6fff);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color:#fff;
    }

    .wrap{
      width: 980px;
      max-width: 96vw;
      background: var(--panel);
      border-radius: 20px;
      padding: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,.35);
    }

    .header{
      width:100%;
      display:block;
      border-radius: 14px;
      margin-bottom: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    select, button, input{
      border: none;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 700;
      font-size: 14px;
      outline: none;
    }

    select, input{
      background: rgba(255,255,255,.92);
      color:#111;
      min-width: 170px;
    }

    button{
      cursor:pointer;
      color:#111;
      background: rgba(255,255,255,.92);
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
      transition: transform .06s ease;
    }
    button:active{ transform: scale(.98); }
    button.primary{
      background: #fff;
    }
    button.ghost{
      background: rgba(255,255,255,.75);
    }

    .stats{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      font-weight: 800;
    }
    .pill{
      background: rgba(0,0,0,.22);
      padding: 8px 10px;
      border-radius: 14px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }

    .main{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 920px){
      .main{ grid-template-columns: 1fr; }
    }

    .boardCard{
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }

    /* Board */
    .board{
      width: 100%;
      aspect-ratio: 1 / 1;
      display:grid;
      gap: var(--gap);
      padding: var(--gap);
      border-radius: 16px;
      background: rgba(255,255,255,.12);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .tile{
      border-radius: var(--radius);
      background-repeat: no-repeat;
      background-size: var(--bgSize);
      background-position: var(--bgPos);
      box-shadow: var(--tileShadow);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
    }

    .tile:active{ transform: scale(.995); }

    .tile.blank{
      background: transparent;
      box-shadow: none;
      cursor: default;
    }

    /* Sidebar */
    .sideCard{
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .sideTitle{
      font-weight: 900;
      font-size: 16px;
      margin: 0 0 8px;
    }
    .hint{
      font-size: 13px;
      opacity: .95;
      line-height: 1.3;
      margin-bottom: 10px;
    }
    .muted{ opacity:.9; font-weight:700; }

    /* Win modal */
    .overlay{
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      z-index: 50;
      padding: 14px;
    }
    .modal{
      width: 520px;
      max-width: 95vw;
      background: rgba(20,20,28,.96);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      position: relative;
      overflow:hidden;
    }
    .modal h2{
      margin: 0 0 6px;
      font-size: 20px;
    }
    .modal p{
      margin: 0 0 10px;
      opacity: .95;
      line-height: 1.3;
      font-weight: 700;
    }
    .modal .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 8px;
      align-items:center;
    }

    /* Leaderboard modal content */
    .leaderboard{
      margin-top: 10px;
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.10);
    }
    .lbRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      font-weight: 700;
      border-bottom: 1px solid rgba(255,255,255,.10);
      font-size: 13px;
    }
    .lbRow:last-child{ border-bottom:none; }
    .lbRow.top1{ background: rgba(255,215,0,.22); }
    .lbRow.top2{ background: rgba(192,192,192,.18); }
    .lbRow.top3{ background: rgba(205,127,50,.18); }
    .lbDivider{
      height: 1px;
      background: rgba(255,255,255,.18);
      margin: 6px 0;
      border-radius: 999px;
    }

    #confettiCanvas{
      position: fixed;
      inset:0;
      pointer-events:none;
      z-index: 60;
      display:none;
    }
  </style>
</head>

<body>
  <canvas id="confettiCanvas"></canvas>

  <div class="wrap">
    <img class="header" src="header.png" alt="Header" />

    <div class="topbar">
      <div class="controls">
        <select id="difficulty">
          <option value="3">Easy (3√ó3)</option>
          <option value="4">Medium (4√ó4)</option>
          <option value="5">Hard (5√ó5)</option>
        </select>

        <select id="puzzleSelect"></select>

        <button id="randomBtn" class="ghost">üé≤ Random</button>
        <button id="startBtn" class="primary">‚ñ∂Ô∏è Start</button>
        <button id="resetBtn" class="ghost">‚Ü©Ô∏è Reset</button>
        <button id="leaderboardBtn" class="ghost">üèÜ Leaderboard</button>
      </div>

      <div class="stats">
        <div class="pill">Moves: <span id="moves">0</span></div>
        <div class="pill">Time: <span id="time">0:00</span></div>
        <div class="pill">Puzzle: <span id="puzzleLabel">1</span></div>
      </div>
    </div>

    <div class="main">
      <div class="boardCard">
        <div id="board" class="board"></div>
      </div>

      <div class="sideCard">
        <p class="sideTitle">How to play</p>
        <div class="hint">
          Scroll puzzles ‚Äî the tiles preview the image in order.<br/>
          Press <b>Start</b> to scramble and play.
        </div>

        <div class="hint" style="margin-top:10px;">
          <span class="muted">Tip:</span> For best quality on 5√ó5, use higher-res source images (e.g. 1000px+).
        </div>

        <div class="hint" style="margin-top:10px;">
          <span class="muted">Note:</span> Firebase scores are stored per grid size (3√ó3 / 4√ó4 / 5√ó5).
        </div>
      </div>
    </div>
  </div>

  <!-- Win overlay -->
  <div class="overlay" id="winOverlay">
    <div class="modal">
      <h2>üéâ You solved it!</h2>
      <p>
        <b><span id="winMoves"></span></b> moves in <b><span id="winTime"></span></b>.
      </p>

      <div class="row">
        <input id="playerName" type="text" maxlength="20" placeholder="Name (for leaderboard)" />
        <button id="submitScoreBtn" class="primary">üèÜ Submit Score</button>
        <button id="closeWinBtn" class="ghost">Close</button>
      </div>

      <div class="hint" style="margin-top:10px; opacity:.9;">
        Scores are saved per difficulty (3√ó3 / 4√ó4 / 5√ó5).
      </div>
    </div>
  </div>

  <!-- Leaderboard overlay -->
  <div class="overlay" id="lbOverlay">
    <div class="modal">
      <h2>üèÜ Leaderboard</h2>
      <p class="hint" style="margin-bottom:6px;">
        Showing top 10 for:
      </p>

      <div class="row" style="margin-top:0;">
        <select id="lbDifficulty">
          <option value="3">Easy (3√ó3)</option>
          <option value="4">Medium (4√ó4)</option>
          <option value="5">Hard (5√ó5)</option>
        </select>
        <button id="lbRefreshBtn" class="primary">üîÑ Refresh</button>
        <button id="lbCloseBtn" class="ghost">Close</button>
      </div>

      <div class="leaderboard" id="lbList" style="margin-top:12px;"></div>

      <div class="hint" style="margin-top:10px; opacity:.9;">
        Ranking: lowest moves, then lowest time.
      </div>
    </div>
  </div>

  <script type="module">
    /************ 1) FIREBASE CONFIG (KEEP THIS AS-IS) ************/
    const firebaseConfig = {
      apiKey: "AIzaSyBGMiQj1QLqcmhzV_qId4eoZzRQVSikjHo",
      authDomain: "littleolliesliderpuzzle.firebaseapp.com",
      projectId: "littleolliesliderpuzzle",
      storageBucket: "littleolliesliderpuzzle.firebasestorage.app",
      messagingSenderId: "1069415747966",
      appId: "1:1069415747966:web:a04eaed2db91802204232f",
      measurementId: "G-4R4VTGXGQH"
    };

    // This is only "true" if you actually have keys present
    const CONFIG_PRESENT =
      !!firebaseConfig?.apiKey &&
      !!firebaseConfig?.projectId &&
      !String(firebaseConfig.apiKey).toUpperCase().includes("PASTE");

    /************ 2) FIREBASE IMPORTS (CDN) ************/
    let firebaseOk = false; // becomes true only if imports + init work
    let db = null, addDoc, collection, getDocs, limit, orderBy, query, serverTimestamp, where;

    if (CONFIG_PRESENT) {
      try {
        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js");
        const firestore = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js");
        ({ addDoc, collection, getDocs, limit, orderBy, query, serverTimestamp, where } = firestore);

        const app = initializeApp(firebaseConfig);
        db = firestore.getFirestore(app);
        firebaseOk = true;
      } catch (e) {
        console.error("Firebase failed to load/init:", e);
        firebaseOk = false;
      }
    }

    /************ 3) GAME STATE ************/
    const boardEl = document.getElementById("board");
    const movesEl = document.getElementById("moves");
    const timeEl = document.getElementById("time");
    const puzzleSelect = document.getElementById("puzzleSelect");
    const difficultyEl = document.getElementById("difficulty");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const randomBtn = document.getElementById("randomBtn");
    const puzzleLabel = document.getElementById("puzzleLabel");
    const leaderboardBtn = document.getElementById("leaderboardBtn");

    // Win overlay
    const winOverlay = document.getElementById("winOverlay");
    const winMovesEl = document.getElementById("winMoves");
    const winTimeEl = document.getElementById("winTime");
    const closeWinBtn = document.getElementById("closeWinBtn");
    const submitScoreBtn = document.getElementById("submitScoreBtn");
    const playerNameEl = document.getElementById("playerName");

    // Leaderboard overlay
    const lbOverlay = document.getElementById("lbOverlay");
    const lbDifficulty = document.getElementById("lbDifficulty");
    const lbRefreshBtn = document.getElementById("lbRefreshBtn");
    const lbCloseBtn = document.getElementById("lbCloseBtn");
    const lbList = document.getElementById("lbList");

    // Confetti
    const confettiCanvas = document.getElementById("confettiCanvas");
    const ctx = confettiCanvas.getContext("2d");

    let N = 3; // grid size
    let puzzleId = 1;
    let imageSrc = "";
    let tiles = [];
    let solved = [];
    let blankPos = 0;
    let moves = 0;
    let started = false;

    let timer = null;
    let startTime = 0;
    let elapsedSec = 0;

    /************ 4) PUZZLE LIST ************/
    function buildPuzzleList() {
      puzzleSelect.innerHTML = "";
      for (let i = 1; i <= 100; i++) {
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = `Puzzle ${i}`;
        puzzleSelect.appendChild(opt);
      }
    }

    /************ 5) IMAGE SLICE BACKGROUND HELPERS ************/
    function setBoardCssVars() {
      boardEl.style.setProperty("--bgSize", `${N * 100}% ${N * 100}%`);
    }

    function bgPosForTile(tileIndex) {
      const r = Math.floor(tileIndex / N);
      const c = tileIndex % N;
      const x = (c / (N - 1)) * 100;
      const y = (r / (N - 1)) * 100;
      return `${x}% ${y}%`;
    }

    /************ 6) BUILD / RENDER ************/
    function buildSolvedState() {
      solved = [];
      for (let i = 0; i < N * N - 1; i++) solved.push(i);
      solved.push(-1);
    }

    function loadPuzzle(id) {
      puzzleId = id;
      puzzleLabel.textContent = String(puzzleId);
      imageSrc = `puzzles/${puzzleId}.png`;

      started = false;
      stopTimer();
      elapsedSec = 0;
      timeEl.textContent = formatTime(0);
      moves = 0;
      movesEl.textContent = "0";

      N = parseInt(difficultyEl.value, 10);
      buildSolvedState();
      tiles = [...solved];
      blankPos = tiles.indexOf(-1);

      renderBoard();
    }

    function renderBoard() {
      setBoardCssVars();
      boardEl.style.gridTemplateColumns = `repeat(${N}, 1fr)`;

      boardEl.innerHTML = "";
      for (let pos = 0; pos < tiles.length; pos++) {
        const tileVal = tiles[pos];
        const d = document.createElement("div");
        d.className = "tile";
        d.dataset.pos = String(pos);

        if (tileVal === -1) {
          d.classList.add("blank");
        } else {
          d.style.backgroundImage = `url(${imageSrc})`;
          d.style.setProperty("--bgPos", bgPosForTile(tileVal));
          d.style.backgroundPosition = d.style.getPropertyValue("--bgPos");
          d.style.imageRendering = "auto";
        }

        d.addEventListener("click", () => onTileClick(pos));
        boardEl.appendChild(d);
      }
    }

    /************ 7) MOVES ************/
    function posToRC(pos){ return [Math.floor(pos / N), pos % N]; }
    function rcToPos(r,c){ return r*N + c; }

    function isAdjacent(a, b) {
      const [ar, ac] = posToRC(a);
      const [br, bc] = posToRC(b);
      const dr = Math.abs(ar - br);
      const dc = Math.abs(ac - bc);
      return (dr + dc) === 1;
    }

    function onTileClick(pos) {
      if (!started) return;
      if (tiles[pos] === -1) return;
      if (!isAdjacent(pos, blankPos)) return;

      [tiles[pos], tiles[blankPos]] = [tiles[blankPos], tiles[pos]];
      blankPos = pos;
      moves++;
      movesEl.textContent = String(moves);

      renderBoard();

      if (checkWin()) onWin();
    }

    function checkWin() {
      for (let i = 0; i < tiles.length; i++) {
        if (tiles[i] !== solved[i]) return false;
      }
      return true;
    }

    /************ 8) SCRAMBLE (SOLVABLE) ************/
    function scrambleSolvable(steps = 1200) {
      tiles = [...solved];
      blankPos = tiles.indexOf(-1);

      let lastBlank = -1;

      for (let i = 0; i < steps; i++) {
        const neighbors = getBlankNeighbors(blankPos).filter(p => p !== lastBlank);
        const pick = neighbors[Math.floor(Math.random() * neighbors.length)];
        lastBlank = blankPos;

        [tiles[pick], tiles[blankPos]] = [tiles[blankPos], tiles[pick]];
        blankPos = pick;
      }
    }

    function getBlankNeighbors(blank) {
      const [r,c] = posToRC(blank);
      const out = [];
      if (r > 0) out.push(rcToPos(r-1, c));
      if (r < N-1) out.push(rcToPos(r+1, c));
      if (c > 0) out.push(rcToPos(r, c-1));
      if (c < N-1) out.push(rcToPos(r, c+1));
      return out;
    }

    /************ 9) TIMER ************/
    function startTimer() {
      stopTimer();
      startTime = Date.now();
      timer = setInterval(() => {
        elapsedSec = Math.floor((Date.now() - startTime) / 1000);
        timeEl.textContent = formatTime(elapsedSec);
      }, 250);
    }
    function stopTimer(){
      if (timer) clearInterval(timer);
      timer = null;
    }
    function formatTime(sec){
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2, "0")}`;
    }

    /************ 10) BUTTONS ************/
    startBtn.addEventListener("click", () => {
      N = parseInt(difficultyEl.value, 10);
      buildSolvedState();
      scrambleSolvable(N === 5 ? 2500 : 1200);

      moves = 0;
      movesEl.textContent = "0";

      started = true;
      startTimer();
      renderBoard();
    });

    resetBtn.addEventListener("click", () => {
      started = false;
      stopTimer();
      elapsedSec = 0;
      timeEl.textContent = formatTime(0);
      moves = 0;
      movesEl.textContent = "0";
      tiles = [...solved];
      blankPos = tiles.indexOf(-1);
      renderBoard();
    });

    randomBtn.addEventListener("click", () => {
      const id = 1 + Math.floor(Math.random() * 100);
      puzzleSelect.value = String(id);
      loadPuzzle(id);
    });

    puzzleSelect.addEventListener("change", () => loadPuzzle(parseInt(puzzleSelect.value, 10)));
    difficultyEl.addEventListener("change", () => loadPuzzle(puzzleId));

    /************ 11) WIN + CONFETTI ************/
    function onWin() {
      started = false;
      stopTimer();

      winMovesEl.textContent = String(moves);
      winTimeEl.textContent = formatTime(elapsedSec);

      winOverlay.style.display = "flex";
      fireConfetti();
    }

    closeWinBtn.addEventListener("click", () => {
      winOverlay.style.display = "none";
      stopConfetti();
    });

    submitScoreBtn.addEventListener("click", async () => {
      const name = (playerNameEl.value || "").trim().slice(0, 20) || "Anon";

      if (!firebaseOk) {
        alert("Firebase isn't loading. Test using your GitHub Pages URL (not file://) and check Console errors.");
        return;
      }

      try {
        await addDoc(collection(db, "slider_scores"), {
          name,
          puzzleId,
          grid: N,
          moves,
          time: elapsedSec,
          createdAt: new Date(),              // ‚úÖ requested
          createdAtServer: serverTimestamp()  // keeps server time too
        });
        playerNameEl.value = "";
        alert("Score submitted! ‚úÖ");
      } catch (e) {
        console.error(e);
        alert("Couldn‚Äôt submit score. Check Firestore rules + indexes. (Open Console for the exact error.)");
      }
    });

    function resizeConfettiCanvas(){
      confettiCanvas.width = Math.floor(window.innerWidth * devicePixelRatio);
      confettiCanvas.height = Math.floor(window.innerHeight * devicePixelRatio);
    }
    window.addEventListener("resize", resizeConfettiCanvas);

    let confetti = [];
    let confettiAnim = null;

    function fireConfetti(){
      resizeConfettiCanvas();
      confettiCanvas.style.display = "block";
      confetti = [];
      const count = 220;

      for (let i=0;i<count;i++){
        confetti.push({
          x: Math.random()*confettiCanvas.width,
          y: -Math.random()*confettiCanvas.height*0.2,
          vx: (Math.random()-0.5)*2.2*devicePixelRatio,
          vy: (2.5 + Math.random()*4.5)*devicePixelRatio,
          r: (3 + Math.random()*6)*devicePixelRatio,
          a: Math.random()*Math.PI*2,
          va: (Math.random()-0.5)*0.25,
          c: `hsl(${Math.floor(Math.random()*360)}, 90%, 60%)`
        });
      }

      const start = performance.now();
      const dur = 3200;

      const tick = (t) => {
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);

        for (const p of confetti){
          p.x += p.vx;
          p.y += p.vy;
          p.a += p.va;

          if (p.x < -50) p.x = confettiCanvas.width + 50;
          if (p.x > confettiCanvas.width + 50) p.x = -50;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.a);
          ctx.fillStyle = p.c;
          ctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
          ctx.restore();
        }

        if (t - start < dur) confettiAnim = requestAnimationFrame(tick);
        else stopConfetti();
      };

      confettiAnim = requestAnimationFrame(tick);
    }

    function stopConfetti(){
      if (confettiAnim) cancelAnimationFrame(confettiAnim);
      confettiAnim = null;
      confettiCanvas.style.display = "none";
    }

    /************ 12) LEADERBOARD POPUP ************/
    leaderboardBtn.addEventListener("click", async () => {
      lbDifficulty.value = String(N);
      lbOverlay.style.display = "flex";
      await refreshLeaderboard(parseInt(lbDifficulty.value, 10));
    });

    lbCloseBtn.addEventListener("click", () => {
      lbOverlay.style.display = "none";
    });

    lbRefreshBtn.addEventListener("click", async () => {
      await refreshLeaderboard(parseInt(lbDifficulty.value, 10));
    });

    lbDifficulty.addEventListener("change", async () => {
      await refreshLeaderboard(parseInt(lbDifficulty.value, 10));
    });

    async function refreshLeaderboard(gridSize){
      lbList.innerHTML = "";

      const header = document.createElement("div");
      header.className = "lbRow";
      header.innerHTML = `<span class="muted">Top 10 (Grid ${gridSize}√ó${gridSize})</span><span class="muted">Moves ‚Ä¢ Time</span>`;
      lbList.appendChild(header);

      if (!firebaseOk) {
        const row = document.createElement("div");
        row.className = "lbRow";
        row.innerHTML = `<span class="muted">Firebase failed to load</span><span class="muted">Check Console</span>`;
        lbList.appendChild(row);
        return;
      }

      try {
        const q = query(
          collection(db, "slider_scores"),
          where("grid","==", gridSize),
          orderBy("moves","asc"),
          orderBy("time","asc"),
          limit(10)
        );

        const snap = await getDocs(q);

        if (snap.empty) {
          const row = document.createElement("div");
          row.className = "lbRow";
          row.innerHTML = `<span class="muted">No scores yet</span><span class="muted">‚Äî</span>`;
          lbList.appendChild(row);
          return;
        }

        let rank = 1;
        snap.forEach(doc => {
          const s = doc.data();
          const row = document.createElement("div");
          row.className = "lbRow";

          if (rank === 1) row.classList.add("top1");
          if (rank === 2) row.classList.add("top2");
          if (rank === 3) row.classList.add("top3");

          row.innerHTML = `
            <span>${rank}. ${escapeHtml(s.name || "Anon")} <span class="muted">(P${s.puzzleId})</span></span>
            <span>${s.moves} ‚Ä¢ ${formatTime(s.time || 0)}</span>
          `;

          lbList.appendChild(row);

          if (rank === 3) {
            const div = document.createElement("div");
            div.className = "lbDivider";
            lbList.appendChild(div);
          }

          rank++;
        });
      } catch (e) {
        console.error(e);
        const row = document.createElement("div");
        row.className = "lbRow";
        row.innerHTML = `<span class="muted">Leaderboard error</span><span class="muted">Rules/index</span>`;
        lbList.appendChild(row);
      }
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /************ 13) INIT ************/
    buildPuzzleList();
    puzzleSelect.value = "1";
    loadPuzzle(1);
  </script>
</body>
</html>
